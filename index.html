<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT Live Streamer (Frame-based)</title>
    <!-- MQTT.js Library -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body {
            background-color: #121212;
            color: white;
            font-family: Arial, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        header {
            background: #1f1f1f;
            padding: 15px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo { color: red; font-weight: bold; font-size: 1.2rem; }
        .status { font-size: 0.8rem; padding: 5px 10px; border-radius: 4px; background: #333; }
        .status.online { background: #006400; }

        /* Main */
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Controls (Left) */
        .sidebar {
            width: 300px;
            background: #181818;
            padding: 20px;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .box {
            background: #252525;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        input, button {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            box-sizing: border-box;
            border-radius: 4px;
            border: none;
        }

        input[type="text"] { background: #333; color: white; border: 1px solid #444; }
        button { cursor: pointer; font-weight: bold; transition: 0.2s; }
        
        .btn-broadcast { background: #cc0000; color: white; }
        .btn-broadcast:hover { background: #ff0000; }
        
        .btn-watch { background: #333; color: white; border: 1px solid #555; }
        .btn-watch:hover { background: #444; }

        .id-display {
            font-family: monospace;
            background: #000;
            padding: 8px;
            margin-top: 5px;
            color: #4caf50;
            user-select: all;
            word-break: break-all;
            cursor: pointer;
        }

        /* Video Area (Right) */
        .stage {
            flex: 1;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* The Viewer Image */
        #stream-display {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: none; /* Hidden until stream starts */
        }

        /* Hidden Source Video */
        #source-video {
            display: none; 
        }

        /* Overlay Text */
        .overlay {
            position: absolute;
            color: #555;
            font-size: 1.2rem;
            pointer-events: none;
        }
    </style>
</head>
<body>

<header>
    <div class="logo">â–¶ MQTT Streamer</div>
    <div id="connection-status" class="status">Connecting to Broker...</div>
</header>

<div class="container">
    <div class="sidebar">
        <!-- Broadcast Section -->
        <div class="box">
            <h3>ðŸŽ¥ Broadcaster</h3>
            <div style="font-size:0.8rem; color:#aaa; margin-bottom:10px;">Select a file to stream frames.</div>
            <input type="file" id="fileInput" accept="video/*">
            <button class="btn-broadcast" onclick="startBroadcast()">START LIVE STREAM</button>
            
            <div id="broadcast-info" style="display:none; margin-top:15px; text-align: left;">
                <span style="font-size:0.8rem; color:#aaa;">Your Topic ID (Copy this):</span>
                <div id="my-topic" class="id-display" onclick="copyId()">...</div>
                <div style="font-size:0.7rem; color:#aaa; margin-top:5px;">Sending Frames: <span id="fps-counter">0</span> FPS</div>
            </div>
        </div>

        <!-- Watch Section -->
        <div class="box">
            <h3>ðŸ‘€ Viewer</h3>
            <input type="text" id="remote-topic" placeholder="Paste Topic ID here">
            <button class="btn-watch" onclick="startWatching()">WATCH STREAM</button>
        </div>
    </div>

    <div class="stage">
        <div class="overlay" id="overlay-msg">Ready</div>
        <!-- We use an IMG tag to display the MJPEG stream -->
        <img id="stream-display" alt="Live Stream">
    </div>
</div>

<!-- Hidden elements for processing -->
<video id="source-video" muted playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>

<script>
    // --- CONFIGURATION ---
    // Using EMQX public broker (Very fast, secure WebSockets)
    const BROKER_URL = 'wss://broker.emqx.io:8084/mqtt';
    
    // Limits to prevent crashing the browser/broker
    const QUALITY = 0.4;    // JPEG Quality (0.1 - 1.0)
    const MAX_WIDTH = 480;  // Resize video to 480px width
    const FPS_LIMIT = 15;   // Limit frames per second
    
    // --- STATE ---
    let client;
    let isBroadcasting = false;
    let streamInterval;
    
    // --- DOM ---
    const els = {
        status: document.getElementById('connection-status'),
        fileInput: document.getElementById('fileInput'),
        myTopic: document.getElementById('my-topic'),
        broadcastInfo: document.getElementById('broadcast-info'),
        streamDisplay: document.getElementById('stream-display'),
        overlay: document.getElementById('overlay-msg'),
        remoteInput: document.getElementById('remote-topic'),
        fps: document.getElementById('fps-counter'),
        sourceVideo: document.getElementById('source-video'),
        canvas: document.getElementById('canvas')
    };

    const ctx = els.canvas.getContext('2d');

    // --- CONNECT MQTT ---
    console.log("Connecting to MQTT...");
    client = mqtt.connect(BROKER_URL);

    client.on('connect', () => {
        console.log("Connected!");
        els.status.textContent = "Online (EMQX Broker)";
        els.status.classList.add('online');
    });

    client.on('error', (err) => {
        console.error("MQTT Error:", err);
        els.status.textContent = "Connection Error";
        els.status.style.background = "red";
    });

    // --- RECEIVER LOGIC ---
    client.on('message', (topic, message) => {
        // Message is a Buffer (JPEG Binary)
        // Convert to Blob URL
        const blob = new Blob([message], { type: 'image/jpeg' });
        const url = URL.createObjectURL(blob);

        // Update the image source
        // Revoke old URL to save memory
        if (els.streamDisplay.src) URL.revokeObjectURL(els.streamDisplay.src);
        
        els.streamDisplay.src = url;
        els.streamDisplay.style.display = 'block';
        els.overlay.style.display = 'none';
    });

    // --- VIEWER FUNCTION ---
    function startWatching() {
        const topic = els.remoteInput.value.trim();
        if(!topic) return alert("Please enter a Topic ID");

        console.log("Subscribing to:", topic);
        
        // Unsubscribe from others
        client.unsubscribe('#');
        
        // Subscribe to new topic
        client.subscribe(topic);
        
        els.overlay.textContent = "Waiting for data...";
    }

    // --- BROADCAST LOGIC ---
    async function startBroadcast() {
        const file = els.fileInput.files[0];
        if(!file) return alert("Select a video file first");

        // 1. Generate ID
        const topicId = 'yt-stream-' + Math.random().toString(36).substr(2, 6);
        els.myTopic.textContent = topicId;
        els.broadcastInfo.style.display = 'block';

        // 2. Play Video Locally (Hidden)
        const url = URL.createObjectURL(file);
        els.sourceVideo.src = url;
        await els.sourceVideo.play();

        // 3. Start Loop
        isBroadcasting = true;
        let lastFrameTime = 0;
        const interval = 1000 / FPS_LIMIT;

        els.overlay.textContent = "Broadcasting...";

        function processFrame(time) {
            if(!isBroadcasting) return;
            requestAnimationFrame(processFrame);

            // Throttle FPS
            if (time - lastFrameTime < interval) return;
            lastFrameTime = time;

            if (els.sourceVideo.paused || els.sourceVideo.ended) return;

            // Draw to Canvas
            // Calculate Aspect Ratio
            const scale = Math.min(1, MAX_WIDTH / els.sourceVideo.videoWidth);
            els.canvas.width = els.sourceVideo.videoWidth * scale;
            els.canvas.height = els.sourceVideo.videoHeight * scale;

            ctx.drawImage(els.sourceVideo, 0, 0, els.canvas.width, els.canvas.height);

            // Convert to JPEG Blob -> Buffer
            els.canvas.toBlob((blob) => {
                if(!blob) return;
                
                // Read blob as ArrayBuffer to send via MQTT
                const reader = new FileReader();
                reader.onload = () => {
                    if (client.connected) {
                        const buffer = new Uint8Array(reader.result);
                        // Publish (QoS 0 = Fire and Forget, fastest)
                        client.publish(topicId, buffer, { qos: 0 });
                        
                        // Visual Feedback
                        els.fps.textContent = Math.round(1000 / (time - (lastFrameTime - interval)));
                    }
                };
                reader.readAsArrayBuffer(blob);

            }, 'image/jpeg', QUALITY);
        }

        requestAnimationFrame(processFrame);
    }

    // --- UTILS ---
    function copyId() {
        navigator.clipboard.writeText(els.myTopic.textContent);
        alert("ID Copied!");
    }

</script>
</body>
</html>
