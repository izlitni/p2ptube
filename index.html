<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure P2P YouTube Clone</title>
    <!-- PeerJS for WebRTC (Secure CDN) -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --red: #ff0000; --bg: #0f0f0f; --card: #1f1f1f; --text: #fff; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; }
        
        /* Navbar */
        header { background: #202020; padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-weight: bold; font-size: 1.2rem; }
        .logo span { color: var(--red); }
        
        /* Main Layout */
        .main { display: flex; flex: 1; height: 100%; }
        
        /* Sidebar Controls */
        .sidebar { width: 300px; background: #151515; padding: 20px; border-right: 1px solid #333; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .card { background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid #333; }
        h3 { margin-top: 0; font-size: 1rem; }
        
        input[type="text"] { width: 100%; padding: 8px; background: #000; color: #fff; border: 1px solid #333; box-sizing: border-box; margin-bottom: 10px; }
        button { width: 100%; padding: 10px; border: none; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .btn-red { background: var(--red); color: white; }
        .btn-gray { background: #333; color: white; }
        
        /* Video Player */
        .content { flex: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; position: relative; }
        video { width: 100%; max-width: 1000px; max-height: 80vh; background: #000; }
        
        /* Debug Console */
        #console { font-family: monospace; font-size: 0.8rem; color: #0f0; background: #000; padding: 10px; border-radius: 4px; height: 150px; overflow-y: auto; margin-top: 10px; border: 1px solid #333; }
        
        /* Secret Canvas for Compatibility */
        canvas { display: none; } 
    </style>
</head>
<body>

<header>
    <div class="logo"><span>&#9654;</span> Youtube P2P (HTTPS Fix)</div>
    <div id="my-peer-id" style="font-family: monospace; font-size: 0.9rem; color: #aaa;">Connecting to server...</div>
</header>

<div class="main">
    <div class="sidebar">
        <!-- Broadcaster -->
        <div class="card">
            <h3>ðŸ”´ Broadcast</h3>
            <input type="file" id="fileInput" accept="video/*">
            <button class="btn-red" onclick="startBroadcast()" style="margin-top:5px;">Start Broadcast</button>
            <div style="font-size: 0.8rem; color: #aaa; margin-top: 5px;">
                1. Select File<br>
                2. Click Start<br>
                3. Copy ID from top right
            </div>
        </div>

        <!-- Viewer -->
        <div class="card">
            <h3>ðŸ‘€ Watch</h3>
            <input type="text" id="remoteId" placeholder="Paste Broadcaster ID">
            <button class="btn-gray" onclick="joinStream()">Watch Stream</button>
        </div>

        <!-- Debug -->
        <div id="console">System Ready...</div>
    </div>

    <div class="content">
        <!-- The Video Player -->
        <video id="videoPlayer" controls playsinline></video>
        <!-- Invisible Canvas for processing video if needed -->
        <canvas id="canvasProcessor"></canvas>
    </div>
</div>

<script>
    // --- VARIABLES ---
    let peer;
    let localStream;
    const logBox = document.getElementById('console');
    const myIdDisplay = document.getElementById('my-peer-id');
    const videoPlayer = document.getElementById('videoPlayer');
    const canvas = document.getElementById('canvasProcessor');
    const ctx = canvas.getContext('2d');

    // --- LOGGING ---
    function log(msg) {
        const line = document.createElement('div');
        line.textContent = `> ${msg}`;
        logBox.appendChild(line);
        logBox.scrollTop = logBox.scrollHeight;
        console.log(msg);
    }

    // --- INITIALIZE PEER (SECURE) ---
    // We use a random ID. The 'secure: true' is default for the public cloud, but explicit here.
    peer = new Peer(null, {
        debug: 1,
        secure: true 
    });

    peer.on('open', (id) => {
        log(`My ID: ${id}`);
        myIdDisplay.textContent = `ID: ${id}`;
        myIdDisplay.style.color = '#fff';
        myIdDisplay.style.userSelect = 'text';
    });

    peer.on('error', (err) => {
        log(`ERROR: ${err.type} - ${err.message}`);
    });

    // --- RECEIVE CALL (BROADCASTER LOGIC) ---
    // When a viewer calls, we answer with our stream
    peer.on('call', (call) => {
        log('Viewer is calling...');
        if (localStream) {
            call.answer(localStream);
            log('Sent stream to viewer.');
        } else {
            log('Error: No stream to send! (Did you start broadcast?)');
        }
    });

    // --- BROADCAST FUNCTION ---
    async function startBroadcast() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];

        if (!file) return log('Please select a video file first.');

        // 1. Play Video Locally
        const url = URL.createObjectURL(file);
        videoPlayer.src = url;
        videoPlayer.muted = true; // Required for autoplay
        
        try {
            await videoPlayer.play();
            log('Video playing locally.');
        } catch (e) {
            log('Autoplay blocked. Please click play on the video.');
        }

        // 2. Capture Stream
        // We try standard capture first, then Firefox specific, then Canvas fallback
        if (videoPlayer.captureStream) {
            localStream = videoPlayer.captureStream();
            log('Standard captureStream success.');
        } else if (videoPlayer.mozCaptureStream) {
            localStream = videoPlayer.mozCaptureStream();
            log('Firefox captureStream success.');
        } else {
            log('Native capture failed. Using Canvas fallback (CPU intensive).');
            startCanvasStream();
        }

        log('Broadcast is Live! Share your ID.');
    }

    // --- CANVAS FALLBACK (For Safari/Compat) ---
    function startCanvasStream() {
        // Match canvas size to video
        canvas.width = videoPlayer.videoWidth || 640;
        canvas.height = videoPlayer.videoHeight || 360;
        
        // Loop drawing
        function draw() {
            if (!videoPlayer.paused && !videoPlayer.ended) {
                ctx.drawImage(videoPlayer, 0, 0, canvas.width, canvas.height);
            }
            requestAnimationFrame(draw);
        }
        draw();

        // Capture from canvas
        localStream = canvas.captureStream(30); // 30 FPS
        
        // Try to add audio track from video if possible (AudioContext magic)
        // Note: Simple canvas capture is video-only. 
        // Audio extraction in single-file without CORS issues is hard.
        log('Warning: Canvas fallback is Video-Only (No Audio).');
    }

    // --- WATCH FUNCTION (VIEWER LOGIC) ---
    function joinStream() {
        const remoteId = document.getElementById('remoteId').value.trim();
        if (!remoteId) return log('Enter an ID.');

        log(`Connecting to ${remoteId}...`);

        // We call the broadcaster. 
        // We send a dummy stream or null because we just want to receive.
        const call = peer.call(remoteId, createEmptyAudioStream());

        call.on('stream', (remoteStream) => {
            log('Stream received!');
            
            videoPlayer.srcObject = remoteStream;
            videoPlayer.muted = false;
            
            const p = videoPlayer.play();
            if (p !== undefined) {
                p.catch(error => {
                    log('Auto-Play blocked by browser. CLICK PLAY on the video bar!');
                });
            }
        });

        call.on('error', (err) => {
            log('Call Error: ' + err);
        });
        
        // Close handler
        call.on('close', () => {
            log('Broadcast ended.');
        });
    }

    // --- HELPER: Create Dummy Audio (Required to initiate some calls) ---
    function createEmptyAudioStream() {
        const ctx = new AudioContext();
        const oscillator = ctx.createOscillator();
        const dst = oscillator.connect(ctx.createMediaStreamDestination());
        oscillator.start();
        return dst.stream;
    }

</script>
</body>
</html>
